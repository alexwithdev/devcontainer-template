name: Build and Push Docker Images

on:
  push:
    branches: [master, main]
    tags: ["v*"]
  pull_request:
    branches: [master, main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-base-and-push:
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    strategy:
      matrix:
        include:
          - name: base
            dockerfile: .devcontainer/Dockerfile
            context: .devcontainer
            description: "Base Alpine development container"
    uses: ./.github/workflows/build-image.yml
    with:
      name: ${{ matrix.name }}
      dockerfile: ${{ matrix.dockerfile }}
      context: ${{ matrix.context }}
      description: ${{ matrix.description }}
      registry: ghcr.io
      image_name: ${{ github.repository }}

  build-and-push:
    needs: build-base-and-push
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    strategy:
      matrix:
        include:
          - name: node
            dockerfile: node/Dockerfile
            context: node
            description: "Node.js development container"
          - name: python
            dockerfile: python/Dockerfile
            context: python
            description: "Python development container"
          - name: go
            dockerfile: go/Dockerfile
            context: go
            description: "Go development container"
    uses: ./.github/workflows/build-image.yml
    with:
      name: ${{ matrix.name }}
      dockerfile: ${{ matrix.dockerfile }}
      context: ${{ matrix.context }}
      description: ${{ matrix.description }}
      registry: ghcr.io
      image_name: ${{ github.repository }}
